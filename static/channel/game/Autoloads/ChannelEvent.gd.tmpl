extends Node

enum {
{{- range $i, $event := .channel_events }}
  {{upperSnake .key}} = {{ $i }},
{{- end }}
}

{{ range $i, $event := .channel_events }}
signal {{.key}}(state, presence)
{{ end }}

var signal_map = {
{{- range $i, $event := .channel_events }}
	{{upperSnake .key}}: "{{ .key }}",
{{- end }}
}


func handle_match_state_update(state: NakamaRTAPI.MatchData):
	if state.presence != null && state.presence.user_id == SessionManager.session.user_id:
		return

	match state.op_code:
		{{- range $i, $event := .channel_events }}
		{{upperSnake .key}}:
			emit_signal("{{.key}}", state.data, state.presence)
		{{- else }}
		_:
			pass
		{{- end }}


func emit(op_code: int, payload: String):
	var event: String = signal_map[op_code]
	emit_signal(event, payload, {"user_id": SessionManager.session.user_id})

	if ChannelManager.game_match != null:
		ChannelManager.socket.send_match_state_async(
			ChannelManager.game_match.match_id, op_code, payload
		)



{{ range $i, $event := .channel_events }}
func {{.key}}(payload):
	emit({{upperSnake .key}}, JSON.print(payload))


{{- end }}
